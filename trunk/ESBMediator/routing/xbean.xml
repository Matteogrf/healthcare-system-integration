<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns:eip="http://servicemix.apache.org/eip/1.0" xmlns="http://xbean.org/schemas/spring/1.0"
	xmlns:wsb="http://events.laboratory.unitn.it" xmlns:tns="http://it.unitn/">


	<!-- Ricevo la richiesta inviata al Web Service Endpoint e la invio al componente 
		di routing content-base-router -->
	<eip:static-routing-slip service="tns:processEventRequest"
		endpoint="staticRouting">
		<eip:targets>
		    <eip:exchange-target service="tns:beanLogEvent" 
				endpoint="LogEvent" operation="logContent" />
				
			<eip:exchange-target service="tns:splitDifferentEvents"
				endpoint="endpoint" />
		</eip:targets>

	</eip:static-routing-slip>

	<!-- Instrado l'evento al mapping associato -->
	<eip:content-based-router service="tns:splitDifferentEvents"
		endpoint="endpoint">
		<eip:rules>
			<eip:routing-rule>
				<eip:predicate>
					<!-- Evento Inserimento Variazione Anagrafica -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=1]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapInserimentoVariazioneAnagrafica"
						endpoint="IVA" />
				</eip:target>
		    </eip:routing-rule>
		    <eip:routing-rule>
				<eip:predicate>
					<!-- Evento Inserimento Variazione Nucleo Fatto -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=2]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapInserimentoVariazioneNucleoFatto"
						endpoint="IVNF" />
				</eip:target>
			</eip:routing-rule>
			<eip:routing-rule>
				<eip:predicate>
					<!-- Evento Scheda Accesso -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=3]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapSchedaAccesso"
						endpoint="SA" />
				</eip:target>
			</eip:routing-rule>
			<eip:routing-rule>
				<eip:predicate>
					<!-- Evento Inizio Presa in Carico -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=4]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapPresaInCarico"
						endpoint="PC" />
				</eip:target>
			</eip:routing-rule>
			<eip:routing-rule>
				<eip:predicate>
					<!-- Evento Fine Presa In Carico -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=5]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapFinePresaInCarico"
						endpoint="FPC" />
				</eip:target>
			</eip:routing-rule>
			<eip:routing-rule>
				<eip:predicate>
					<!-- Evento Fine Presa In Carico -->
					<eip:xpath-predicate xpath="/*[//Descrizione/TipoEventoCod=6]" />
				</eip:predicate>
				<eip:target>
					<eip:exchange-target service="tns:mapAssegnazioneAreaUtenza"
						endpoint="AAU" />
				</eip:target>
			</eip:routing-rule>
		</eip:rules>
	</eip:content-based-router>
	
	<eip:static-routing-slip service="tns:mapSchedaAccesso"
		endpoint="SA">
		<eip:targets>
			<eip:exchange-target service="tns:mappingSA"
				endpoint="mappingSA"></eip:exchange-target>
		    
		    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>

	<eip:static-routing-slip service="tns:mapInserimentoVariazioneNucleoFatto"
		endpoint="IVNF">
		<eip:targets>
			<eip:exchange-target service="tns:mappingIVNF"
				endpoint="mappingIVNF"></eip:exchange-target>
		    
		    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>


	<eip:static-routing-slip service="tns:mapInserimentoVariazioneAnagrafica"
		endpoint="IVA">
		<eip:targets>
			<eip:exchange-target service="tns:mappingIVA"
				endpoint="mappingIVA"></eip:exchange-target>
				
						    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>
	
	<eip:static-routing-slip service="tns:mapPresaInCarico"
		endpoint="PC">
		<eip:targets>
			<eip:exchange-target service="tns:mappingPC"
				endpoint="mappingPC"></eip:exchange-target>
				
						    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>
	
	<eip:static-routing-slip service="tns:mapFinePresaInCarico"
		endpoint="FPC">
		<eip:targets>
			<eip:exchange-target service="tns:mappingFPC"
				endpoint="mappingFPC"></eip:exchange-target>
				
						    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>
	
	<eip:static-routing-slip service="tns:mapAssegnazioneAreaUtenza"
		endpoint="AAU">
		<eip:targets>
			<eip:exchange-target service="tns:mappingAAU"
				endpoint="mappingAAU"></eip:exchange-target>
				
						    <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" />

			<eip:exchange-target service="wsb:DwhWS" />

			<eip:exchange-target service="tns:convertDwhResponse"
				endpoint="convertDwhResponse" />
		</eip:targets>
	</eip:static-routing-slip>


	<!-- <eip:static-recipient-list service="tns:logAndSend" endpoint="mappedEvents"> 
		<eip:recipients> <eip:exchange-target service="tns:beanLogEvent" endpoint="LogEvent" 
		operation="logContentNoForward" /> <eip:exchange-target service="wsb:DwhWS" 
		/> </eip:recipients> </eip:static-recipient-list> -->


	<!-- Eseguo il mapping relativo all'evento Inserimento Variazione Anagrafica 
		e inoltro il risultato al Datawarehouse WS <eip:pipeline service="tns:mapInserimentoVariazioneAnagrafica" 
		endpoint="IVA"> <eip:transformer> <eip:exchange-target service="tns:mappingIVA" 
		endpoint="mappingIVA"></eip:exchange-target> </eip:transformer> <eip:target> 
		<eip:exchange-target service="tns:logAndSend" endpoint="mappedEvents"></eip:exchange-target> 
		</eip:target> </eip:pipeline> -->


	<!-- Devo utilizzare questo componente per poter processare l'evento in 
		modo da poterlo salvare nella staging area. In questo modo riesco ad avvisare 
		il client dell' avvenuta consegna dell'evento all'ESB <eip:wire-tap service="tns:wireTrap" 
		endpoint="endpoint"> <eip:target> <eip:exchange-target service="tns:beanLogEvent" 
		endpoint="LogEvent" operation="logContent" /> </eip:target> <eip:inListener> 
		<eip:exchange-target service="tns:splitDifferentEvents" endpoint="endpoint" 
		/> </eip:inListener> </eip:wire-tap> -->
</beans>

